<%- include('../layout/user_header.ejs') %>
<main class="main">
    <div class="page-header breadcrumb-wrap">
        <div class="container">
            <div class="breadcrumb">
                <a href="/" rel="nofollow">Home</a>
                <span></span> Account
            </div>
        </div>
    </div>
    <section class="pt-150 pb-150">
        <div class="container">
            <div class="row">
                <div class="col-lg-10 m-auto">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="dashboard-menu">
                                <ul class="nav flex-column" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab" aria-controls="dashboard" aria-selected="false">
                                            <i class="fi-rs-settings-sliders mr-10"></i>Dashboard
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="orders-tab" data-bs-toggle="tab" href="#orders" role="tab" aria-controls="orders" aria-selected="false">
                                            <i class="fi-rs-shopping-bag mr-10"></i>Orders
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="address-tab" data-bs-toggle="tab" href="#address" role="tab" aria-controls="address" aria-selected="false">
                                            <i class="fi-rs-marker mr-10"></i>My Address
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="account-detail-tab" data-bs-toggle="tab" href="#account-detail" role="tab" aria-controls="account-detail" aria-selected="false">
                                            <i class="fi-rs-user mr-10"></i>Account details
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="/logout" onclick="localStorage.removeItem('activeTab')">
                                            <i class="/userDashboardfi-rs-sign-out mr-10"></i>Logout
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="tab-content dashboard-content">
                                <div class="tab-pane fade" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Hello <%= user.name %>! </h5>
                                        </div>
                                        <div class="card-body">
                                            <p>From your account dashboard, you can easily check &amp; view your <a href="#">recent orders</a>, manage your <a href="#">shipping and billing addresses</a>, and <a href="#">edit your password and account details.</a></p>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
                                <% if (orderData && orderData.length > 0) { %>
                                    <% orderData.forEach(order => { %>
                                        <div class="order-card card mb-3" style="border-radius: 10px;"data-order-id="<%= order._id %>">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#orderDetails-<%= order._id %>">
                                                    <div>
                                                        <p class="mb-1"><strong>Order Number:</strong> #<%= order._id %></p>
                                                        <p class="mb-1"><strong>Total:</strong> Rs <%= order.totalAmount %></p>
                                                        <p class="mb-1"><strong>Order Date:</strong> <%= new Date(order.orderDate).toLocaleDateString() %></p>
                                                        <p class="mb-1"><strong>Payment Method:</strong> <%= order.paymentMethod %></p>
                                                    </div>
                                                    <div id="orderStatus<%= order._id %>" class="text-warning">
                                                        <strong><%= order.orderStatus.toUpperCase() %></strong>
                                                    </div>
                                                </div>
                                                <div id="orderDetails-<%= order._id %>" class="collapse">
                                                    <hr>
                                                    <div class="mb-3">
                                                        <p class="mb-1">Order Date: <%= new Date(order.orderDate).toLocaleDateString() %></p>
                                                        <p class="mb-1">Ship To: <%= order.shippingAddress.fullname %></p>
                                                        <p class="mb-1" style="margin-left: 55px;"><%= order.shippingAddress.Address %></p>
                                                        <p class="mb-1" style="margin-left: 55px;"><%= order.shippingAddress.city %>, <%= order.shippingAddress.state %></p>
                                                        <p class="mb-1" style="margin-left: 55px;">Pincode: <%= order.shippingAddress.pincode %></p>
                                                        
                                                    </div>


                                                    <% order.items.forEach(item => { %>
                                                        <div class="d-flex mb-3">
                                                            <div class="flex-shrink-0 me-3" style="width: 50px;">
                                                                <% if (item.images && item.images.length > 0) { %>
                                                                    <img src="/imgs/products/<%= item.images[0] %>" alt="Product Image" class="img-fluid">
                                                                <% } else { %>
                                                                    <span>No image</span>
                                                                <% } %>
                                                            </div>
                                                            <div class="flex-grow-1" >
                                                                <p class="mb-1"><strong>Name:</strong> <%= item.productName %></p>
                                                                <p class="mb-1"><strong>Brand:</strong> <%= item.brandName %></p>
                                                                <p class="mb-0"><strong>Price:</strong> Rs <%= item.price %> inc GST</p>
                                                                <p class="mb-0"><strong>quantity:</strong> x <%= item.quantity %></p>
                                                                <p id="itemOrderStatus<%= item._id %>" class="order-product-status mb-0 text-warning">
                                                                    <strong>Status: <%= item.itemOrderStatus.toUpperCase() %></strong>
                                                                </p>
                                                            </div>
                                                            
                                                            <div>
                                                               
                                                              <!-- Disable Cancel Button for returnInitiated, returnApproved, returnRejected statuses -->
                                                            <% if (['returnInitiated', 'returnApproved', 'returnRejected'].includes(item.itemOrderStatus)) { %>
                                                               
                                                                <button id="cancelProductButton<%= item._id %>" class="btn btn-sm individualCancel" disabled>
                                                                   return
                                                                </button>
                                                            <% } else if (item.itemOrderStatus !== 'delivered') { %>
                                                       
                                                                <button id="cancelProductButton<%= item._id %>" class="btn btn-sm individualCancel" 
                                                                    onclick="cancelOrderItem('<%= item._id %>', '<%= order._id %>', '<%= item.itemOrderStatus %>')"
                                                                    <%= item.itemOrderStatus === 'cancelled' ? 'disabled' : '' %> >
                                                                    <%= item.itemOrderStatus === 'cancelled' ? 'Cancelled' : 'Cancel' %>
                                                                </button>
                                                            <% } %>

                                                            <!-- Return Button -->
                                                            <% if (item.itemOrderStatus === 'delivered') { %>
                                                              
                                                                <button id="returnProductButton<%= item._id %>" class="btn btn-primary btn-sm" 
                                                                    onclick="returnProduct('<%= item._id %>','<%= item.product %>', '<%= order._id %>','<%= item.itemOrderStatus %>')"
                                                                    <%= ['returnInitiated', 'returnApproved', 'returnRejected'].includes(item.itemOrderStatus) ? 'disabled' : '' %>>
                                                                    Return
                                                                </button>
                                                            <% } %>
   
                                                              
                                                            </div>
                                                        </div>
                                                    <% }); %>
                                                    <div class="mb-3">
                                                        
                                                        <p class="mb-1"><strong>Subtotal:</strong> Rs <%= order.subTotalAmount %></p>
                                                        <p class="mb-1"><strong>Discount:</strong> Rs <%= order.discountAmount %></p>
                                                        <p class="mb-1"><strong>Total:</strong> Rs <%= order.totalAmount %></p>
                                                        <p class="mb-1"><strong>Payment Method:</strong> <%= order.paymentMethod %></p>
                                                    </div>
                                                    <div class="text-end">
                                                        <% const shouldDisableCancelOrder = order.items.some(item => ['returnInitiated', 'returnApproved', 'returnRejected'].includes(item.itemOrderStatus)); %>
                                                        <% if (order.orderStatus !== 'delivered' && order.orderStatus !== 'cancelled') { %>
                                                           <!-- <button class="btn btn-secondary btn-sm" onclick="getInvoice('order._id ')">Invoice</button> -->
                                                            <!-- <button class="btn btn-sm" id="cancelOrderButton< order._id %>" 
                                                                onclick="cancelOrder('< order._id %>', ' order.orderStatus %>')"
                                                                 shouldDisableCancelOrder ? 'disabled' : '' %>>
                                                                Cancel Order
                                                            </button> -->
                                                        <% } else { %>
                                                           <!-- <button class="btn btn-secondary btn-sm" onclick="getInvoice(' order._id %>')">Invoice</button> -->
                                                            <button class="btn btn-secondary btn-sm" disabled>
                                                                <%= order.itemOrderStatus === 'cancelled' ? 'Cancelled' : 'Cancel Order' %>

                                                            </button>
                                                            
                                                        <% } %>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    <% }); %>
                                <% } else { %>
                                    <p>No orders found.</p>
                                <% } %>
                            </div>
                                <div class="tab-pane fade" id="address" role="tabpanel" aria-labelledby="address-tab">
                                    <div class="d-flex justify-content-end mb-3">
                                        <button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#add-address-form">Add New Address</button>
                                    </div>
                                    <div id="add-address-form" class="collapse">
                                        <form method="post" action="/add-address/<%= user._id %>">
                                            
                                            <div class="row">
                                                <div class="form-group col-md-12">
                                                    <label>Name <span class="required">*</span></label>
                                                    <input required="" class="form-control square" name="name" type="text" placeholder="Enter name">
                                                </div>
                                                <div class="form-group col-md-6">
                                                    <label>Phone <span class="required">*</span></label>
                                                    <input required="" class="form-control square" name="phone" type="text" placeholder="Enter phone number">
                                                </div>
                                                <div class="form-group col-md-6">
                                                    <label>Alternative Phone</label>
                                                    <input class="form-control square" name="alt_phone" type="text" placeholder="Enter alternative phone number">
                                                </div>
                                                <div class="form-group col-md-12">
                                                    <label>Address <span class="required">*</span></label>
                                                    <input required="" class="form-control square" name="Address" type="text" placeholder="Enter address">
                                                </div>
                                                <div class="form-group col-md-6">
                                                    <label>City <span class="required">*</span></label>
                                                    <input required="" class="form-control square" name="city" type="text" placeholder="Enter city">
                                                </div>
                                                <div class="form-group col-md-6">
                                                    <label>State/Province <span class="required">*</span></label>
                                                    <select required="" class="form-control square" name="state">
                                                        <option value="Andhra Pradesh">Andhra Pradesh</option>
                                                        <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                                                        <option value="Assam">Assam</option>
                                                        <option value="Bihar">Bihar</option>
                                                        <option value="Chhattisgarh">Chhattisgarh</option>
                                                        <option value="Goa">Goa</option>
                                                        <option value="Gujarat">Gujarat</option>
                                                        <option value="Haryana">Haryana</option>
                                                        <option value="Himachal Pradesh">Himachal Pradesh</option>
                                                        <option value="Jharkhand">Jharkhand</option>
                                                        <option value="Karnataka">Karnataka</option>
                                                        <option value="Kerala">Kerala</option>
                                                        <option value="Madhya Pradesh">Madhya Pradesh</option>
                                                        <option value="Maharashtra">Maharashtra</option>
                                                        <option value="Manipur">Manipur</option>
                                                        <option value="Meghalaya">Meghalaya</option>
                                                        <option value="Mizoram">Mizoram</option>
                                                        <option value="Nagaland">Nagaland</option>
                                                        <option value="Odisha">Odisha</option>
                                                        <option value="Punjab">Punjab</option>
                                                        <option value="Rajasthan">Rajasthan</option>
                                                        <option value="Sikkim">Sikkim</option>
                                                        <option value="Tamil Nadu">Tamil Nadu</option>
                                                        <option value="Telangana">Telangana</option>
                                                        <option value="Tripura">Tripura</option>
                                                        <option value="Uttar Pradesh">Uttar Pradesh</option>
                                                        <option value="Uttarakhand">Uttarakhand</option>
                                                        <option value="West Bengal">West Bengal</option>
                                                    </select>
                                                </div>
                                                <div class="form-group col-md-6">
                                                    <label>Pincode <span class="required">*</span></label>
                                                    <input required="" class="form-control square" name="pincode" type="text" placeholder="Enter pincode">
                                                </div>
                                                <div class="form-group col-md-12">
                                                    <button type="submit" class="btn btn-fill-out submit" name="submit" value="Submit">Save Address</button>
                                                    <button type="button" class="btn btn-secondary ms-2" data-bs-toggle="collapse" data-bs-target="#add-address-form">Cancel</button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="list-group mt-3">
                                        <!-- Loop through addresses and render them -->
                                        <% user.address.forEach((address, index) => { %>
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <% if(address.primary ) { %>
                                                    <span style="padding: 2%; background-color: grey;">primary</span>
                                                    <% } %>
                                                    <strong><%= address.fullname %> <%= address.mobile %></strong>
                                                    <p><%= address.Address %>, <%= address.city %>, <%= address.state %></p>
                                                </div>
                                                <div>
                                                    <!-- Button for dropdown menu -->
                                                    <button class="btn p-0" type="button" style="background-color: rgba(0, 0, 0, 0.126);" data-bs-toggle="dropdown" aria-expanded="false">
                                                        <i class="bi bi-three-dots-vertical"></i>
                                                    </button>
                                                    <ul class="dropdown-menu">
                                                        <li>
                                                            <a class="dropdown-item" href="#" data-bs-toggle="collapse" data-bs-target="#edit-address-<%= index %>">Edit</a>
                                                        </li>
                                                        <% if(user.address.length>1) {%>
                                                        <li>
                                                            <a class="dropdown-item" href="#" onclick="confirmDelete('<%= address._id %>')">Delete</a>
                                                        </li>
                                                        <% } %>
                                                    </ul>
                                                </div>
                                                                                                
                                            </div>
                                            <div id="edit-address-<%= index %>" class="collapse mt-3">
                                                <form method="post" action="/update-address/<%= address._id %>">
                                                    
                                                    <div class="row">
                                                        <div class="form-group col-md-12">
                                                            <label>Name <span class="required">*</span></label>
                                                            <input  class="form-control square" name="name" type="text" value="<%= address.fullname %>" placeholder="<%= address.fullname %>">
                                                        </div>
                                                        <div class="form-group col-md-6">
                                                            <label>Phone <span class="required">*</span></label>
                                                            <input  class="form-control square" name="phone" type="text" value="<%= address.mobile %>" placeholder="<%= address.mobile %>">
                                                        </div>
                                                        <div class="form-group col-md-6">
                                                            <label>Alternative Phone</label>
                                                            <input class="form-control square" name="alt_phone" type="text" value="<%= address.altMobile %>" placeholder="<%= address.altMobile %>">
                                                        </div>
                                                        <div class="form-group col-md-12">
                                                            <label>Address <span class="required">*</span></label>
                                                            <input  class="form-control square" name="address" type="text" value="<%= address.Address %>" placeholder="<%= address.Address %>">
                                                        </div>
                                                        <div class="form-group col-md-6">
                                                            <label>City <span class="required">*</span></label>
                                                            <input  class="form-control square" name="city" type="text" value="<%= address.city %>" placeholder="<%= address.city %>">
                                                        </div>
                                                        <div class="form-group col-md-6">
                                                            <label>State <span class="required">*</span></label>
                                                            <select class="form-control square" name="state">
                                                                <option value="Andhra Pradesh" <%= address.state === 'Andhra Pradesh' ? 'selected' : '' %>>Andhra Pradesh</option>
                                                                <option value="Arunachal Pradesh" <%= address.state === 'Arunachal Pradesh' ? 'selected' : '' %>>Arunachal Pradesh</option>
                                                                <option value="Assam" <%= address.state === 'Assam' ? 'selected' : '' %>>Assam</option>
                                                                <option value="Bihar" <%= address.state === 'Bihar' ? 'selected' : '' %>>Bihar</option>
                                                                <option value="Chhattisgarh" <%= address.state === 'Chhattisgarh' ? 'selected' : '' %>>Chhattisgarh</option>
                                                                <option value="Goa" <%= address.state === 'Goa' ? 'selected' : '' %>>Goa</option>
                                                                <option value="Gujarat" <%= address.state === 'Gujarat' ? 'selected' : '' %>>Gujarat</option>
                                                                <option value="Haryana" <%= address.state === 'Haryana' ? 'selected' : '' %>>Haryana</option>
                                                                <option value="Himachal Pradesh" <%= address.state === 'Himachal Pradesh' ? 'selected' : '' %>>Himachal Pradesh</option>
                                                                <option value="Jharkhand" <%= address.state === 'Jharkhand' ? 'selected' : '' %>>Jharkhand</option>
                                                                <option value="Karnataka" <%= address.state === 'Karnataka' ? 'selected' : '' %>>Karnataka</option>
                                                                <option value="Kerala" <%= address.state === 'Kerala' ? 'selected' : '' %>>Kerala</option>
                                                                <option value="Madhya Pradesh" <%= address.state === 'Madhya Pradesh' ? 'selected' : '' %>>Madhya Pradesh</option>
                                                                <option value="Maharashtra" <%= address.state === 'Maharashtra' ? 'selected' : '' %>>Maharashtra</option>
                                                                <option value="Manipur" <%= address.state === 'Manipur' ? 'selected' : '' %>>Manipur</option>
                                                                <option value="Meghalaya" <%= address.state === 'Meghalaya' ? 'selected' : '' %>>Meghalaya</option>
                                                                <option value="Mizoram" <%= address.state === 'Mizoram' ? 'selected' : '' %>>Mizoram</option>
                                                                <option value="Nagaland" <%= address.state === 'Nagaland' ? 'selected' : '' %>>Nagaland</option>
                                                                <option value="Odisha" <%= address.state === 'Odisha' ? 'selected' : '' %>>Odisha</option>
                                                                <option value="Punjab" <%= address.state === 'Punjab' ? 'selected' : '' %>>Punjab</option>
                                                                <option value="Rajasthan" <%= address.state === 'Rajasthan' ? 'selected' : '' %>>Rajasthan</option>
                                                                <option value="Sikkim" <%= address.state === 'Sikkim' ? 'selected' : '' %>>Sikkim</option>
                                                                <option value="Tamil Nadu" <%= address.state === 'Tamil Nadu' ? 'selected' : '' %>>Tamil Nadu</option>
                                                                <option value="Telangana" <%= address.state === 'Telangana' ? 'selected' : '' %>>Telangana</option>
                                                                <option value="Tripura" <%= address.state === 'Tripura' ? 'selected' : '' %>>Tripura</option>
                                                                <option value="Uttar Pradesh" <%= address.state === 'Uttar Pradesh' ? 'selected' : '' %>>Uttar Pradesh</option>
                                                                <option value="Uttarakhand" <%= address.state === 'Uttarakhand' ? 'selected' : '' %>>Uttarakhand</option>
                                                                <option value="West Bengal" <%= address.state === 'West Bengal' ? 'selected' : '' %>>West Bengal</option>
                                                            </select>
                                                        </div>
                                                        
                                                        <div class="form-group col-md-6">
                                                            <label>Pincode <span class="required">*</span></label>
                                                            <input  class="form-control square" name="pincode" type="text" value="<%= address.pincode %>" placeholder="Enter pincode">
                                                        </div>
                                                        
                                                        <div class="form-group col-md-12">
                                                            <button type="submit" class="btn btn-fill-out submit" name="submit" value="Submit">Update Address</button>
                                                            <button type="button" class="btn btn-secondary ms-2" data-bs-toggle="collapse" data-bs-target="#edit-address-<%= index %>">Cancel</button>
                                                        </div>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                        <% }) %>    
                                    </div>
                                    
                                   
                                </div>
                                <div class="tab-pane fade" id="account-detail" role="tabpanel" aria-labelledby="account-detail-tab">
                                    <!-- Section 1: Personal Information -->
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5>Personal Information</h5>
                                            <!-- Edit Button -->
                                            <span class="edit-link text-primary" onclick="toggleEditMode('personal-info')" style="cursor: pointer;">Edit</span>
                                        </div>
                                    
                                        <!-- View Mode: Personal Information -->
                                        <div class="card-body" id="personal-info-view">
                                            <p><strong>User Name:</strong> <%= user.name %></p>
                                            <p><strong>Mobile:</strong> <%= user.mobile %></p>
                                        </div>
                                    
                                        <!-- Edit Mode: Personal Information Form -->
                                        <div class="card-body" id="personal-info-edit" style="display: none;">
                                            <form method="post" id="personal-info-form" onsubmit="editPersonaldetails(event)">
                                                <div class="row">
                                                    <!-- User Name -->
                                                    <div class="form-group col-md-6">
                                                        <label for="name">User Name</label>
                                                        <input id="name" class="form-control" name="name" type="text" value="<%= user.name %>" required />
                                                        <span id="username-error" class="error-message"></span>
                                                    </div>
                                    
                                                    <!-- Mobile Number -->
                                                    <div class="form-group col-md-6">
                                                        <label for="mobile">Mobile Number</label>
                                                        <input id="mobile" class="form-control" name="mobile" type="text" value="<%= user.mobile %>" pattern="^(?:(?:\+91|91)?[6789]\d{9})$" required />
                                                        <span id="mobile-error" class="error-message"></span>
                                                    </div>
                                    
                                                    <!-- Save and Cancel Buttons -->
                                                    <div class="form-group col-md-12 d-flex justify-content-end">
                                                        <button type="button" class="btn btn-secondary btn-sm me-2" onclick="toggleEditMode('personal-info')">Cancel</button>
                                                        <button type="submit" class="btn btn-primary btn-sm">Save</button>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                    
                                    <!-- Section 2: Change Email -->
                                    <div class="card mt-4">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5>Change Email</h5>
                                            <!-- Edit Button -->
                                            <span class="edit-link text-primary" onclick="toggleEditMode('change-email')" style="cursor: pointer;">Edit</span>
                                        </div>
                                    
                                        <!-- View Mode: Display Current Email -->
                                        <div class="card-body" id="change-email-view">
                                            <p><strong>Email:</strong> <%= user.email %></p>
                                        </div>
                                    
                                        <!-- Edit Mode: Change Email Form -->
                                        <div class="card-body" id="change-email-edit" style="display: none;">
                                            <form method="post" id="change-email-form" onsubmit="changeEmail(event)">
                                                <div class="row">
                                                    <!-- Current Email -->
                                                    <div class="form-group col-md-6">
                                                        <label for="current-email">Current Email</label>
                                                        <input id="current-email" class="form-control" name="currentEmail" type="email" value="<%= user.email %>" readonly />
                                                    </div>
                                    
                                                    <!-- New Email -->
                                                    <div class="form-group col-md-6">
                                                        <label for="new-email">New Email</label>
                                                        <input id="new-email" class="form-control" name="newEmail" type="email" required />
                                                        <span id="new-email-error" class="error-message"></span>
                                                    </div>
                                    
                                                    <!-- Confirm New Email -->
                                                    <div class="form-group col-md-6">
                                                        <label for="confirm-new-email">Confirm New Email</label>
                                                        <input id="confirm-new-email" class="form-control" name="confirmNewEmail" type="email" required />
                                                        <span id="confirm-new-email-error" class="error-message"></span>
                                                    </div>
                                    
                                                    <!-- Save and Cancel Buttons -->
                                                    <div class="form-group col-md-12 d-flex justify-content-end">
                                                        <button type="button" class="btn btn-secondary btn-sm me-2" onclick="toggleEditMode('change-email')">Cancel</button>
                                                        <button type="submit" class="btn btn-primary btn-sm">Save</button>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>                                    
                                
                                    <!-- Section 3: Change Password -->
                                    <div class="card mt-4">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5>Change Password</h5>
                                            <!-- Edit Button -->
                                            <span class="edit-link text-primary" onclick="toggleEditMode('change-password')" style="cursor: pointer;">Edit</span>
                                        </div>
                                
                                        <!-- Edit Mode: Change Password Form (Visible when Edit is clicked) -->
                                        <div class="card-body" id="change-password-edit" style="display: none;">
                                            <form method="post" id="change-password-form">
                                                <div class="row">
                                                    <!-- Current Password -->
                                                    <div class="form-group col-md-6">
                                                        <label for="current-password">Current Password</label>
                                                        <input id="current-password" class="form-control" name="currentPass" type="password" required />
                                                    </div>
                                
                                                    <!-- New Password -->
                                                    <div class="form-group col-md-6">
                                                        <label for="new-password">New Password</label>
                                                        <input id="new-password" class="form-control" name="newPass" type="password" required />
                                                    </div>
                                
                                                    <!-- Confirm New Password -->
                                                    <div class="form-group col-md-6">
                                                        <label for="confirm-new-password">Confirm New Password</label>
                                                        <input id="confirm-new-password" class="form-control" name="confirmNewPass" type="password" required />
                                                    </div>
                                
                                                    <!-- Save and Cancel Buttons -->
                                                    <div class="form-group col-md-12 d-flex justify-content-end">
                                                        <button type="button" class="btn btn-secondary btn-sm me-2" onclick="toggleEditMode('change-password')">Cancel</button>
                                                        <button type="submit" class="btn btn-primary btn-sm">Save</button>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
              
                            </div>
                        </div> 
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<style>
   
.form-check {
    margin-bottom: 10px;
}


.form-check-label {
    margin-left: 5px;
    vertical-align: middle;
}


.form-check-input {
    margin-right: 5px; 
}
/* Style for the Edit and Cancel links */
.edit-link {
    font-weight: 500;
    font-size: 0.9rem;
    text-decoration: underline;
    cursor: pointer;
}

.edit-link:hover {
    text-decoration: none;
}

/* Customizing form controls */
.form-control {
    border-radius: 4px;
    border-color: #ced4da;
}

/* Adding padding to the card */
.card-body {
    padding: 1.5rem;
}

/* Alignment for buttons */
.form-group .btn {
    border-radius: 4px;
}

/* Space between buttons */
.btn-secondary.me-2 {
    margin-right: 0.5rem;
}
.error {
    border-color: red;
}
.error-message {
    color: red;
    font-size: 0.875em;
}


</style>


<script>

    async function editPersonaldetails(event) {
        event.preventDefault(); // Corrected method name
    
        const form = document.getElementById('personal-info-form');
        const formData = new FormData(form);
    
        // Disable buttons to prevent multiple submissions
        form.querySelector('button.btn-secondary').disabled = true;
        form.querySelector('button.btn-primary').disabled = true;
    
        const nameInput = form.querySelector('input[name="name"]');
        const mobileInput = form.querySelector('input[name="mobile"]');
        const usernameError = document.getElementById('username-error');
        const mobileError = document.getElementById('mobile-error');
    
        // Clear previous error messages
        usernameError.textContent = '';
        mobileError.textContent = '';
        nameInput.classList.remove('error');
        mobileInput.classList.remove('error');
    
        const usernameValue = nameInput.value.trim();
        const mobileValue = mobileInput.value.trim();
    
        // Validate username
        if (usernameValue === '' || /\s/.test(usernameValue)) {
            usernameError.textContent = 'Username cannot be empty or contain spaces.';
            nameInput.classList.add('error');
            form.querySelector('button.btn-secondary').disabled = false; // Re-enable Cancel button
            form.querySelector('button.btn-primary').disabled = false; // Re-enable Save button
            return;
        }
    
        // Validate mobile number
        const mobilePattern = /^(?:(?:\+91|91)?[6789]\d{9})$/;
        if (!mobilePattern.test(mobileValue)) {
            mobileError.textContent = 'Please enter a valid mobile number.';
            mobileInput.classList.add('error');
            form.querySelector('button.btn-secondary').disabled = false; // Re-enable Cancel button
            form.querySelector('button.btn-primary').disabled = false; // Re-enable Save button
            return;
        }
    
        try {
            const response = await fetch('/userDashboard/updatePersonal', {
                method: 'PATCH',
                body: formData 
            });
    
            if (!response.ok) throw new Error('Server responded with an error');
    
            const data = await response.json();
    
            if (data.success) {
                document.querySelector('#personal-info-view p:nth-child(1)').innerHTML = `<strong>User Name:</strong> ${data.user.name}`;
                document.querySelector('#personal-info-view p:nth-child(2)').innerHTML = `<strong>Mobile:</strong> ${data.user.mobile}`;
                nameInput.value=data.user.name
                mobileInput.value=data.user.mobile
    
                document.getElementById('personal-info-edit').style.display = 'none';
                document.getElementById('personal-info-view').style.display = 'block';
    
                Swal.fire('Success', 'Your personal information has been updated!', 'success');
            } else {
                Swal.fire('Error', data.message || 'Failed to update your information.', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire('Error', 'An unexpected error occurred. Please try again.', 'error');
        } finally {
            // Re-enable the buttons
            form.querySelector('button.btn-secondary').disabled = false;
            form.querySelector('button.btn-primary').disabled = false;
        }
    }

    
    async function changeEmail(event) {
        event.preventDefault(); // Prevent default form submission
    
        const form = document.getElementById('change-email-form');
        const formData = new FormData(form);
    
        // Disable buttons to prevent multiple submissions
        form.querySelector('button.btn-secondary').disabled = true;
        form.querySelector('button.btn-primary').disabled = true;
    
        const newEmailInput = form.querySelector('input[name="newEmail"]');
        const confirmNewEmailInput = form.querySelector('input[name="confirmNewEmail"]');
        const newEmailValue = newEmailInput.value.trim();
        const confirmNewEmailValue = confirmNewEmailInput.value.trim();
    
        const newEmailError = document.getElementById('new-email-error'); // Create an error message span if needed
        const confirmEmailError = document.getElementById('confirm-new-email-error'); // Create an error message span if needed
    
        // Clear previous error messages
        if (newEmailError) newEmailError.textContent = '';
        if (confirmEmailError) confirmEmailError.textContent = '';
        newEmailInput.classList.remove('error');
        confirmNewEmailInput.classList.remove('error');
    
        // Validate new email
        if (newEmailValue === '' || !/\S+@\S+\.\S+/.test(newEmailValue)) {
            if (newEmailError) newEmailError.textContent = 'Please enter a valid new email address.';
            newEmailInput.classList.add('error');
            form.querySelector('button.btn-secondary').disabled = false;
            form.querySelector('button.btn-primary').disabled = false;
            return;
        }
    
        // Validate email confirmation
        if (newEmailValue !== confirmNewEmailValue) {
            if (confirmEmailError) confirmEmailError.textContent = 'New email and confirmation do not match.';
            confirmNewEmailInput.classList.add('error');
            form.querySelector('button.btn-secondary').disabled = false;
            form.querySelector('button.btn-primary').disabled = false;
            return;
        }
    
        try {
            const response = await fetch('/userDashboard/changeEmail', {
                method: 'PATCH',
                body: formData 
            });
    
            if (!response.ok) throw new Error('Server responded with an error');
    
            const data = await response.json();
    
            if (data.success) {
                document.querySelector('#change-email-view p').innerHTML = `<strong>Email:</strong> ${newEmailValue}`;
    
                document.getElementById('change-email-edit').style.display = 'none';
                document.getElementById('change-email-view').style.display = 'block';
    
                Swal.fire('Success', 'Your email has been updated!', 'success');
            } else {
                Swal.fire('Error', data.message || 'Failed to update your email.', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire('Error', 'An unexpected error occurred. Please try again.', 'error');
        } finally {
            // Re-enable the buttons
            form.querySelector('button.btn-secondary').disabled = false;
            form.querySelector('button.btn-primary').disabled = false;
        }
    }
    

    function toggleEditMode(section) {
        const viewMode = document.getElementById(`${section}-view`);
        const editMode = document.getElementById(`${section}-edit`);
    
        // Ensure the elements exist (change-password section doesn't have a view mode)
        if (editMode && (viewMode || section === 'change-password')) {
            if (editMode.style.display === "none") {
                // Switch to Edit Mode
                editMode.style.display = "block";
                if (viewMode) viewMode.style.display = "none";
            } else {
                // Switch back to View Mode
                editMode.style.display = "none";
                if (viewMode) viewMode.style.display = "block";
            }
        }
    }
    
   
    document.addEventListener('DOMContentLoaded', function () {
        
        const activeTabId = localStorage.getItem('activeTab') || 'dashboard-tab';
        
        console.log("Active Tab from localStorage:", activeTabId);

       
        const activeTab = document.querySelector(`#${activeTabId}`);
        if (activeTab) {
           
            new bootstrap.Tab(activeTab).show();
        } else {
            console.log("Active Tab not found!");
        }

        
        document.querySelectorAll('.nav-link').forEach(tab => {
            tab.addEventListener('click', function () {
                
                console.log("Clicked Tab:", this.id);
                localStorage.setItem('activeTab', this.id);
            });
        });
    });

    function confirmDelete(addressId) {
        if (confirm('Are you sure you want to delete this address?')) {
            
            window.location.href = '/delete-address/' + addressId;
        }
        
    }

 
 


    const cancelOrderItem = (itemId, orderId,itemOrderStatus) => {
   
        console.log(`Cancel product ${itemId} in order ${orderId},${itemOrderStatus}`);
    
                Swal.fire({
                    title: 'Are you sure?',
                    text: "You are about to cancel this product.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, cancel it!'
                }).then((result)=>{
    
                    if(result.isConfirmed){
    
                        fetch(`http://localhost:3000/orders`,{
    
                        method:"PATCH",
                        headers:{
    
                            "Content-Type":"application/json"
                        },
    
                        body:JSON.stringify({itemId, orderId,itemOrderStatus})
    
                        }).then((response)=>{
    
                            if (!response.ok) {
    
                            return response.json().then(errorData => {
    
                                throw new Error(errorData.error || "Network response was not ok");
    
                            });
                        }
    
                            return response.json()
    
    
                        }).then((data)=>{
    
                            console.log(data);
    
                            if(data.success){
    
                                Swal.fire({
                                            icon: 'success',
                                            text: 'The product has been cancelled successfully.',
                                            toast: true,
                                            position: 'top-right',
                                            showConfirmButton: false,
                                            timerProgressBar: true,
                                            timer: 3000
                                        });
    
                            const button = document.getElementById(`cancelProductButton${itemId}`);
                            button.disabled = true;
                            button.textContent = 'Cancelled';
    
                            const orderProductStatusElement = document.getElementById(`itemOrderStatus${itemId}`);
    
                            if (orderProductStatusElement) {
    
                                orderProductStatusElement.innerHTML = '<strong>Status: CANCELLED</strong>';
    
                            }
                             // Check if all items are cancelled and update the order status
                    if (data.allOrderCancelled) {
                        const cancelOrderButton = document.getElementById(`cancelOrderButton${orderId}`);
                        if (cancelOrderButton) {
                            cancelOrderButton.disabled = true;
                            cancelOrderButton.textContent = "Cancelled";
                        }
    
                        const orderStatusElement = document.getElementById(`orderStatus${orderId}`);
                        if (orderStatusElement) {
                            orderStatusElement.innerHTML = '<strong>CANCELLED</strong>';
                        }
    
                        // Update the status of all products in the order
                        const orderProductStatusElements = document.querySelectorAll('.order-product-status');
                        orderProductStatusElements.forEach(element => {
                            element.innerHTML = '<strong>Status: CANCELLED</strong>';
                        });
    
                        const individualCancelButtons = document.querySelectorAll(".individualCancel");
                        individualCancelButtons.forEach(button => {
                            button.disabled = true;
                            button.textContent = "Cancelled";
                        });
                    }
                            
    
                            }
                     }).catch((error)=>{
    
                            console.log(`you have already cancelled the product,Error while cancelling product`, error.message);
    
                            Swal.fire({
                                        icon: 'error',
                                        text: `Error: ${error.message}`,
                                        toast: true,
                                        position: 'top-right',
                                        showConfirmButton: false,
                                        timerProgressBar: true,
                                        timer: 3000
                                    });
    
                            })
    
                                                    
    
                      }
                })
        
    };
    
</script>

<%- include('../layout/user_footer.ejs') %>
