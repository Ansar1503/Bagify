<%- include('../layout/user_header.ejs') %>

<div class="container mt-5 p-5" id="mainContainer">
  <div class="row">
    <!-- Main Cart Content -->
    <% if (!cart || cart.items.length === 0) { %>
    <div class="col-12 text-center">
      <h2>Your cart is empty!</h2>
      <p>Add items to it now.</p>
      <a href="/shop" class="btn btn-primary">Shop now</a>
    </div>
    <% } else { %>

    <div class="col-md-8" id="sendCartItem">
      <% cart.items.forEach(item => { %>
      <div class="card mb-3" id="productContainer">
        <div class="row no-gutters">
          <div class="col-md-4 d-flex align-items-center justify-content-center">
            <img src="imgs/products/<%= item.product?.product_images[0] %>" class="card-img" style="width: 150px; height: 150px; object-fit: cover; margin-bottom: 15px;" alt="Product Image">
          </div>
          <div class="col-md-8">
            <div class="card-body">
              <h5 class="card-title"><%= item.product?.name %></h5>
              <strong>Price:</strong> <span style="color: green;"> ₹<%= item.price %></span> <del style="color: red; <%= item.regularPrice === item.price ? 'display: none;' : '' %>">₹<%= item.regularPrice %></del>
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <div class="me-2">Qty:</div>
                  <button class="btn btn-sm btn-secondary decrease-quantity" data-product-item-id="<%= item._id %>" onclick="decreaseQuantity('<%= item._id %>')">-</button>
                  <span class="quantity-display mx-2"><%= item.quantity %></span>
                  <button class="btn btn-sm btn-secondary increase-quantity" data-product-item-id="<%= item._id %>" onclick="addQuantity('<%= item._id %>','<%= item.product.product_quantity %>')">+</button>
                </div>
                <span class="text-secondary" style="text-decoration: none; cursor: pointer; margin-bottom: 50px;" onclick="removeItem('<%= item._id %>')">Remove</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <% }) %>
    </div>

    <!-- Order Summary -->
    <div class="col-md-4" style="position: sticky; top: 0; height: 100vh;">
      <div class="card mb-3"> 
        <div class="card">
          <div class="card-body">
              <!-- Apply Coupon Button -->
              <div class="d-flex mt-3">
                <button type="button" id="openCouponModalButton" class="btn btn-primary btn-sm" onclick="openCouponModal()">Apply Coupon</button>
              </div>
            </div>
       </div>
        <div class="card-body">
          <h5 class="card-title">ORDER SUMMARY</h5>
          <p class="card-text d-flex justify-content-between">
            <span id="selection">Price (<%= cart.items.length %> items)</span>
            <span id="subTotalPrice">₹<%= summary.subtotal %></span>
          </p>
          <p class="card-text d-flex justify-content-between">
            <span>Delivery Charges</span>
            <span id="deliveryCharge" class="text-success"><%= summary.deliveryCharges > 0 ? `₹${summary.deliveryCharges}` : 'Free' %></span>
          </p>
          <p class="card-text d-flex justify-content-between">
            <span>Coupon Discount</span>
            <span id="couponDiscount" class="text-success">₹ 0.00</span>
          </p>
          <hr>
          <p class="card-text d-flex justify-content-between">
            <strong>Total Amount</strong>
            <strong><span id="totalPrice">₹<%= summary.total %></span></strong>
          </p>
        </div>
        
        <div class="row">
          <div class="col" id="checkout">
            <a href="/checkoutpage/<%= cart.user._id %>">
              <button type="submit" id="checkoutButton" class="btn custom-button btn-lg w-100" <%= parseFloat(summary.total) === 0 ? 'disabled' : '' %>>Proceed to Check Out</button>
            </a>
          </div>
        </div>
      </div>
    </div>
    <% } %>
  </div>
</div>



<div class="modal fade" id="couponModal" tabindex="-1" aria-labelledby="couponModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="couponModalLabel">Available Coupons</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <% availableCoupons.forEach(coupon => { %>
            <div class="col-md-6 mb-3">
              <div class="card h-100 shadow-sm border-0">
                <div class="card-body d-flex flex-column justify-content-between">
                  <div>
                    <h6 class="card-title text-dark">
                      <i class="bi bi-ticket-fill me-2"></i> 
                      <%= coupon.couponName %>
                    </h6>                    
                    <p class="card-text">
                      <strong>Discount:</strong> <%= coupon.couponDiscount %>% 
                    </p>
                    <p class="card-text">
                      <strong>Min Amount:</strong> <%= coupon.minAmount %> Rs
                    </p>
                    <p class="card-text">
                      <strong>Max Discount Amount:</strong> <%= coupon.maxAmount %> Rs
                    </p>
                    <p class="card-text">
                      <strong>Code:</strong> <span class="badge bg-secondary"><%= coupon.couponCode %></span>
                    </p>
                  </div>
                  <button type="button" class="btn btn-primary btn-sm mt-2" onclick="selectCoupon('<%= coupon.couponCode %>','<%= coupon.couponDiscount %>')">
                    <i class="bi bi-check-circle me-1"></i> Apply
                  </button>
                </div>
              </div>
            </div>
          <% }); %>
        </div>
      </div>
    </div>
  </div>
</div>


<script>

  
  const openCouponModal = () => {
       const couponModal = new bootstrap.Modal(document.getElementById('couponModal'));
       couponModal.show();
     };
   
     
     const selectCoupon = async(couponCode) => {
     
       document.getElementById('couponCode').value = couponCode ;
       document.getElementById('selectCouponButton').style.display = 'none';
       document.getElementById('couponButtons').style.display = 'block';
   
       
       const couponModal = bootstrap.Modal.getInstance(document.getElementById('couponModal'));
       couponModal.hide();
       await applyCoupon();
     };

     const applyCoupon= async () =>{

      const couponCodeElement = document.getElementById('couponCode');
    
      const couponCode = couponCodeElement ? couponCodeElement.value : '';
    
        try {
            const response = await fetch(`/cart/applyCoupon`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ couponCode })
            });
    
            const data = await response.json();
    
            if (data.success) {
                document.getElementById('subTotalPrice').innerText = `Rs ${data.subTotal.toFixed(2)}`;
                document.getElementById('totalPrice').innerText = `Rs ${data.finalPrice.toFixed(2)}`;
                document.getElementById('couponDiscount').innerText = `Rs ${data.discount.toFixed(2)}`
    
                document.getElementById('couponButtons').style.display = 'block';
    
                Swal.fire({
                  icon: 'success',
                  text: 'Coupon applied successfully.',
                  toast: true,
                  position: 'top-right',
                  showConfirmButton: false,
                  timerProgressBar: true,
                  timer: 3000
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    text: data.message,
                    toast: true,
                    position: 'top-right',
                    showConfirmButton: false,
                    timerProgressBar: true,
                    timer: 3000
                });
            }
        } catch (error) {
    
            console.error('Error applying coupon:', error);
    
            Swal.fire({
              icon: 'error',
              text: 'An error occurred while applying the coupon.',
              toast: true,
              position: 'top-right',
              showConfirmButton: false,
              timerProgressBar: true,
              timer: 3000
            });
    
        }
    }    
  
  async function removeItem(itemId) {
    const result = await Swal.fire({
      title: 'Are you sure?',
      text: 'You won\'t be able to revert this!',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Yes, remove it!',
      cancelButtonText: 'No, cancel!'
    });

    if (result.isConfirmed) {
      try {
        const response = await fetch(`/removeItem?itemId=${itemId}`, { method: 'DELETE' });
        if (!response.ok) throw new Error('Server responded with an error');

        const data = await response.json();
        if (data.success) {
          if (!data.isEmpty) {
            const itemElement = document.querySelector(`[data-product-item-id="${itemId}"]`).closest('.card.mb-3');
            if (itemElement) {
              itemElement.remove();
              updateOrderSummaryFromServer(data.summary);
              return;
            }
          }

          if (data.isEmpty) {
            const mainContainer = document.getElementById('mainContainer');
            if (mainContainer) {
              mainContainer.innerHTML = '';

              const emptyCartMessage = document.createElement('div');
              emptyCartMessage.className = 'col-12 text-center';
              emptyCartMessage.innerHTML = `
                <h2>Your cart is empty!</h2>
                <p>Add items to it now.</p>
                <a href="/shop" class="btn btn-primary">Shop now</a>
              `;
              
              mainContainer.appendChild(emptyCartMessage); 
            }
          }
        } else {
          Swal.fire('Error!', `There was a problem removing the item: ${data.message}`, 'error');
        }
      } catch (error) {
        console.error('Failed to remove item:', error);
        Swal.fire('Error!', `An unexpected error occurred: ${error.message}`, 'error');
      }
    }
  }

  // Function to increase quantity of an item
  async function addQuantity(itemId, itemQuantity) {
    try {
      const quantityDisplay = document.querySelector(`[data-product-item-id="${itemId}"]`).closest('.card.mb-3').querySelector('.quantity-display');
      const currentQuantity = parseInt(quantityDisplay.textContent, 10);
      
      if (currentQuantity >= parseInt(itemQuantity) || currentQuantity >= 5) {
        Swal.fire('Limit Reached', 'You can’t add any more of this product.', 'info');
        return;
      }

      const response = await fetch(`/increase-quantity?itemId=${itemId}`, { method: 'PATCH' });
      if (!response.ok) throw new Error('Server responded with an error');

      const data = await response.json();
      if (data.success) {
        quantityDisplay.textContent = data.updatedQuantity;
        document.querySelector(`[data-product-item-id="${itemId}"]`).closest('.card.mb-3').querySelector('.decrease-quantity').disabled = false;
        updateOrderSummaryFromServer(data.summary);
      } else {
        Swal.fire('Error!', 'There was a problem updating the quantity.', 'error');
      }
    } catch (error) {
      console.error('Failed to update quantity:', error);
      Swal.fire('Error!', `An unexpected error occurred: ${error.message}`, 'error');
    }
  }

  // Function to decrease quantity of an item
  async function decreaseQuantity(itemId) {
    try {
      const quantityDisplay = document.querySelector(`[data-product-item-id="${itemId}"]`).closest('.card.mb-3').querySelector('.quantity-display');
      const currentQuantity = parseInt(quantityDisplay.textContent, 10);
      
      if (currentQuantity <= 1) {
        Swal.fire('Minimum Quantity', 'You cannot reduce the quantity below 1.', 'info');
        return;
      }

      const response = await fetch(`/decrease-quantity?itemId=${itemId}`, { method: 'PATCH' });
      if (!response.ok) throw new Error('Server responded with an error');

      const data = await response.json();
      if (data.success) {
        quantityDisplay.textContent = data.updatedQuantity;
        if (data.updatedQuantity == 1) {
          document.querySelector(`[data-product-item-id="${itemId}"]`).closest('.card.mb-3').querySelector('.decrease-quantity').disabled = true;
        }
        updateOrderSummaryFromServer(data.summary);
      } else {
        Swal.fire('Error!', 'There was a problem updating the quantity.', 'error');
      }
    } catch (error) {
      console.error('Failed to update quantity:', error);
      Swal.fire('Error!', `An unexpected error occurred: ${error.message}`, 'error');
    }
  }

  // Function to update the order summary from the server response
  function updateOrderSummaryFromServer(summary) {
    const subTotalPrice = document.getElementById('subTotalPrice');
    const totalPrice = document.getElementById('totalPrice');
    const deliveryCharge = document.getElementById('deliveryCharge');
    const checkoutButton = document.getElementById('checkoutButton');
    const couponDiscount = document.getElementById('couponDiscount');

    if (subTotalPrice) {
      subTotalPrice.textContent = `₹${summary.subtotal}`;
    }

    if (totalPrice) {
      totalPrice.textContent = `₹${summary.total}`;
    }

    if (deliveryCharge) {
      deliveryCharge.textContent = summary.deliveryCharges > 0 ? `₹${summary.deliveryCharges}` : 'Free';
    }

    if (couponDiscount) {
      couponDiscount.textContent = `₹${summary.couponDiscount}`;
    }

    if (checkoutButton) {
      checkoutButton.disabled = parseFloat(summary.total) === 0;
    }
  }

  
</script>

<%- include('../layout/user_footer.ejs') %>
